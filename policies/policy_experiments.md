# –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

‚ÑπÔ∏è ***–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ö–∞–∫ —É–∂–µ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å —Ä–∞–Ω–µ–µ, –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–µ—Ç —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–æ–º –∏ –ø–æ—Ç–æ–∫–æ–º, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ —è–¥—Ä–µ –æ–Ω–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Å—É—â–Ω–æ—Å—Ç—å ‚Äî `task_struct`. –í —Å–≤—è–∑–∏ —Å —ç—Ç–∏–º –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ—Ç–æ–∫–∏ `pthread`, –±–ª–∞–≥–æ–¥–∞—Ä—è –∏—Ö —É–¥–æ–±—Å—Ç–≤—É. –¢–∞–∫–∂–µ –≤—Å–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –Ω–∞ 1 —è–¥—Ä–µ.*

## –ó–Ω–∞–∫–æ–º—Å—Ç–æ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏:

Legacy –≤–∞—Ä–∏–∞–Ω—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ftrace:
```bash
‚ûú  policies sudo -s
‚ûú  policies mkdir nodev
‚ûú  policies sudo mount -t tracefs /sys/kernel/tracing nodev
```

–°–∫—Ä–∏–ø—Ç [*tracer.sh*](./tracer.sh) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤—â–∏–∫–æ–≤ (–≤ –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ ‚Äî `function`). –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 1 —Å–µ–∫—É–Ω–¥—ã, –ø–æ—Å–ª–µ —á–µ–≥–æ –≤—ã–≤–æ–¥–∏—Ç —Å–æ–±—Ä–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
```bash
#!/bin/bash

echo function > nodev/current_tracer
echo 1 > nodev/tracing_on

sleep 1

less nodev/trace

echo nop > nodev/current_tracer
echo 0 > nodev/tracing_on
```

–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã:
```
# tracer: function
#
# entries-in-buffer/entries-written: 410078/3608198   #P:8
#
#                                _-----=> irqs-off/BH-disabled
#                               / _----=> need-resched
#                              | / _---=> hardirq/softirq
#                              || / _--=> preempt-depth
#                              ||| / _-=> migrate-disable
#                              |||| /     delay
#           TASK-PID     CPU#  |||||  TIMESTAMP  FUNCTION
#              | |         |   |||||     |         |
            Xorg-86340   [002] d..3. 94193.591209: _raw_spin_lock <-raw_spin_rq_lock_nested
            Xorg-86340   [002] d..3. 94193.591209: update_rq_clock <-__schedule
            Xorg-86340   [002] d..3. 94193.591209: dequeue_task <-__schedule
            Xorg-86340   [002] d..3. 94193.591210: dequeue_task_fair <-dequeue_task
            Xorg-86340   [002] d..3. 94193.591210: dequeue_entity <-dequeue_task_fair
            Xorg-86340   [002] d..3. 94193.591210: update_curr <-dequeue_entity
            Xorg-86340   [002] d..3. 94193.591210: update_curr_se <-update_curr
            Xorg-86340   [002] d..3. 94193.591210: update_min_vruntime <-update_curr
            Xorg-86340   [002] d..3. 94193.591210: cpuacct_charge <-update_curr
##### CPU 6 buffer started ####
          <idle>-0       [006] d..4. 94193.602450: _raw_spin_unlock <-__get_next_timer_interrupt
##### CPU 4 buffer started ####
            code-87225   [004] ...1. 94193.623782: rseq_get_rseq_cs <-rseq_ip_fixup
##### CPU 7 buffer started ####
            code-87211   [007] ...1. 94193.635145: obj_cgroup_charge <-__memcg_slab_post_alloc_hook
##### CPU 3 buffer started ####
              sh-93966   [003] ...1. 94193.648195: mod_objcg_state <-__memcg_slab_free_hook
##### CPU 1 buffer started ####
     cpuUsage.sh-93967   [001] ...2. 94193.651719: __mod_node_page_state <-__lruvec_stat_mod_folio
     cpuUsage.sh-93967   [001] ...2. 94193.651719: __mod_memcg_lruvec_state <-__lruvec_stat_mod_folio
     cpuUsage.sh-93967   [001] ...2. 94193.651719: cgroup_rstat_updated <-__mod_memcg_lruvec_state
     cpuUsage.sh-93967   [001] ...2. 94193.651719: __rcu_read_unlock <-__lruvec_stat_mod_folio
     ... [output omitted] ...
```
–û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–∫–æ–≥–æ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–µ—É–¥–æ–±–Ω–æ. –ü–æ—ç—Ç–æ–º—É –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `trace-cmd` (API), –∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî `kernelshark`.

–ü–æ–¥—Ä–æ–±–Ω—ã–µ –≥–∞–π–¥—ã –æ—Ç –°—Ç–∏–≤–µ–Ω–∞ –†–æ—Å—Ç–µ–¥—Ç–∞ (—Å–æ–∑–¥–∞—Ç–µ–ª—è –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö —É—Ç–∏–ª–∏—Ç) –º–æ–∂–Ω–æ –≥–ª—è–Ω—É—Ç—å –∑–¥–µ—Å—å:
- üì∫[*Steven Rostedt - Learning the Linux Kernel with tracing*](https://www.youtube.com/watch?v=JRyrhsx-L5Y&t=1975s)
- üì∫[*KernelShark 1.0 is Here; What Does that Mean? - Steven Rostedt, VMware*](https://www.youtube.com/watch?v=ZlYCE7Kte8k)


## –û–±—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–ª–∏—Ç–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å —Å–ª–µ–¥—É—é—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ [*`thread_runner.cpp`*](./thread_runner.cpp) —Å –∫–ª–∞—Å—Å–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ—Ç–æ–∫–∏ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ [*`policy.cpp`*](./policy.cpp), –∏—Å–ø–æ–ª—å–∑—É—é—â–∞—è `ThreadRunner` –∏ –ø–µ—Ä–µ–¥–∞—é—â–∞—è –µ–º—É —Ç–µ—Å—Ç—ã –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
- –£—Ç–∏–ª–∏—Ç—ã `trace-cmd` –∏ `kernelshark` –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏


–í—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥—ã:
```bash
‚ûú  policies sudo trace-cmd record -o dat_file_name.dat -e sched:sched_switch sudo taskset -c 0 ./policy > output_file_name 
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π *–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏* –∏ –±—É–¥—É—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å —Å–æ–±–æ–π:
- *dat_file_name.dat* - —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (–Ω–µ —è–≤–ª—è–µ—Ç—Å—è human-readable)
- ~~*trace.log*~~ - —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (–≤–µ—Ä–æ—è—Ç–Ω–æ –±—É–¥–µ—Ç —É–±—Ä–∞–Ω, —Ç.–∫. –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤ –æ–±—ä–µ–º–µ), –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–µ–≥–∫–æ –ø–æ–ª—É—á–µ–Ω –∫–æ–º–∞–Ω–¥–æ–π `trace-cmd report dat_file_name.dat > trace.log`
- *test.png* - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
- *ps.log* - —Å–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è ps
- *race.log* - –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤
- ~~*output.txt*~~ - –≤—ã–≤–æ–¥ –∏–∑ –ø–æ—Ç–æ–∫–æ–≤ (–≤–µ—Ä–æ—è—Ç–Ω–æ –±—É–¥–µ—Ç —É–±—Ä–∞–Ω, —Ç.–∫. –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤ –æ–±—ä–µ–º–µ)
- *–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã*

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 1: SCHED_OTHER —Å —Ä–∞–≤–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

```cpp
void testCFSEq() {
    ThreadRunner thread_runner({
        Param(SCHED_OTHER, 0, 0),
        Param(SCHED_OTHER, 0, 1),
        Param(SCHED_OTHER, 0, 2),
        Param(SCHED_OTHER, 0, 3),
        Param(SCHED_OTHER, 0, 4),
        Param(SCHED_OTHER, 0, 5),
        Param(SCHED_OTHER, 0, 6),
        Param(SCHED_OTHER, 0, 7),
        Param(SCHED_OTHER, 0, 8),
        Param(SCHED_OTHER, 0, 9),
    });
    thread_runner.run();
}
```

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Å–∂–∞—Ç—ã–π –≤—ã–≤–æ–¥ *compressed_output.txt*:
```
0...0 17225
4...4 27731
2...2 8029
0...0 9149
8...8 3951
1...1 4740
4...4 4724
5...5 9466
... [output omitted] ...
8...8 3701
9...9 225
2...2 7981
6...6 4055
7...7 3781
1...1 3925
2...2 1512
8...8 1129
7...7 3105
```
–ó–¥–µ—Å—å –æ—Ç—á–µ—Ç–ª–∏–≤–æ –≤–∏–¥–Ω–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏.

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testCFSEq/testCFSEq.png)  

–ù–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –≤–∏–¥–Ω–æ, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–µ—Ç –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–Ω—è—Ç —Ä–∞–∑–Ω—ã–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏ (–≤–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: CPU 0). –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–≤—ã—Ç—è–Ω—É—Ç—ã–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏) —É –∫–∞–∂–¥–æ–≥–æ –∏–∑ –ø–æ—Ç–æ–∫–æ–≤.

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 2: SCHED_OTHER —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

```cpp
void testCFSDiff() {
    ThreadRunner thread_runner({
        Param(SCHED_OTHER, 20, 0),
        Param(SCHED_OTHER, 20, 1),
        Param(SCHED_OTHER, -19, 2),
        Param(SCHED_OTHER, 20, 3),
        Param(SCHED_OTHER, 20, 4),
        Param(SCHED_OTHER, -19, 5),
        Param(SCHED_OTHER, 0, 6),
        Param(SCHED_OTHER, -19, 7),
        Param(SCHED_OTHER, 20, 8),
        Param(SCHED_OTHER, 20, 9),
    });
    thread_runner.run();
}
```

–ó–¥–µ—Å—å –Ω–∞—Å –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞—Ç—å —Ñ–∞–π–ª *race.log*:
```
done thread with id: 2
done thread with id: 5
done thread with id: 7
done thread with id: 6
done thread with id: 1
done thread with id: 4
done thread with id: 3
done thread with id: 0
done thread with id: 8
done thread with id: 9
```
–ú–æ–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É).

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testCFSDiff/testCFSDiff.png)  
–ó–¥–µ—Å—å —è–≤–Ω–æ –≤–∏–¥–Ω–æ, —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –ø–æ—Ç–æ–∫–∏ 2 5 7 —Å –≤—ã—Å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º (NI: -19), –¥–∞–ª–µ–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –ø–æ—Ç–æ–∫ 6 (NI: 0), –∞ –ø–æ—Å–ª–µ - –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ.


## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 3: SCHED_FIFO —Å —Ä–∞–≤–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

```cpp
void testFIFOEq() {
    ThreadRunner thread_runner({
        Param(SCHED_FIFO, 30, 0),
        Param(SCHED_FIFO, 30, 1),
        Param(SCHED_FIFO, 30, 2),
        Param(SCHED_FIFO, 30, 3),
        Param(SCHED_FIFO, 30, 4),
        Param(SCHED_FIFO, 30, 5),
        Param(SCHED_FIFO, 30, 6),
        Param(SCHED_FIFO, 30, 7),
        Param(SCHED_FIFO, 30, 8),
        Param(SCHED_FIFO, 30, 9),
    });
    thread_runner.run();
}
```

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Å–∂–∞—Ç—ã–π –≤—ã–≤–æ–¥ *compressed_output.txt*:
```
0...0 100000
1...1 100000
2...2 100000
3...3 100000
4...4 100000
5...5 100000
6...6 100000
7...7 100000
8...8 100000
9...9 100000
```
–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, —á—Ç–æ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å, –ø–æ—Ç–æ–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.


–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testFIFOEq/testFIFOEq.png)  
–ó–¥–µ—Å—å —Ç–∞–∫–∂–µ –≤–∏–¥–Ω–æ, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.

–í–∑–≥–ª—è–Ω–µ–º –Ω–∞ –ª–æ–≥ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ *testFIFOEq.log*:
```bash
‚ûú  testFIFOEq trace-cmd report testFIFOEq.dat | grep policy | grep -v kworker | grep -v sh > testFIFOEq.log
```
```
... [output omitted] ...
          policy-124660 [006] 107138.057919: sched_switch:         taskset:124660 [120] R ==> migration/6:55 [0]
          policy-124660 [000] 107138.059992: sched_switch:         policy:124660 [120] D ==> policy:124661 [120]
          policy-124660 [000] 107138.061276: sched_switch:         policy:124660 [120] D ==> policy:124662 [120]
          policy-124662 [000] 107138.165118: sched_switch:         policy:124662 [69] D ==> policy:124673 [69]
          policy-124662 [000] 107138.165638: sched_switch:         policy:124662 [69] S ==> ksoftirqd/0:16 [120]
     ksoftirqd/0-16    [000] 107138.165642: sched_switch:         ksoftirqd/0:16 [120] S ==> policy:124663 [120]
          policy-124663 [000] 107138.272236: sched_switch:         policy:124663 [69] D ==> policy:124674 [69]
          policy-124663 [000] 107138.272936: sched_switch:         policy:124663 [69] S ==> policy:124662 [69]
          policy-124664 [000] 107138.378610: sched_switch:         policy:124664 [69] D ==> policy:124675 [69]
          policy-124664 [000] 107138.379099: sched_switch:         policy:124664 [69] S ==> policy:124662 [69]
          policy-124665 [000] 107138.486057: sched_switch:         policy:124665 [69] D ==> policy:124676 [69]
          policy-124665 [000] 107138.486642: sched_switch:         policy:124665 [69] S ==> policy:124662 [69]
          policy-124666 [000] 107138.592395: sched_switch:         policy:124666 [69] D ==> policy:124677 [69]
          policy-124666 [000] 107138.592960: sched_switch:         policy:124666 [69] S ==> policy:124662 [69]
          policy-124667 [000] 107138.698438: sched_switch:         policy:124667 [69] D ==> policy:124687 [69]
          policy-124667 [000] 107138.698938: sched_switch:         policy:124667 [69] S ==> policy:124662 [69]
          policy-124668 [000] 107138.732106: sched_switch:         policy:124668 [69] R ==> migration/0:20 [0]
     migration/0-20    [000] 107138.732109: sched_switch:         migration/0:20 [0] S ==> policy:124668 [69]
          policy-124668 [000] 107138.805574: sched_switch:         policy:124668 [69] D ==> policy:124688 [69]
          policy-124668 [000] 107138.806205: sched_switch:         policy:124668 [69] S ==> policy:124662 [69]
          policy-124662 [000] 107138.806211: sched_switch:         policy:124662 [69] S ==> policy:124669 [120]
          policy-124669 [000] 107138.912518: sched_switch:         policy:124669 [69] D ==> policy:124689 [69]
          policy-124669 [000] 107138.913004: sched_switch:         policy:124669 [69] S ==> policy:124662 [69]
          policy-124670 [000] 107139.019487: sched_switch:         policy:124670 [69] D ==> policy:124690 [69]
          policy-124670 [000] 107139.020141: sched_switch:         policy:124670 [69] S ==> policy:124662 [69]
          policy-124671 [000] 107139.126667: sched_switch:         policy:124671 [69] D ==> policy:124691 [69]
          policy-124671 [000] 107139.127151: sched_switch:         policy:124671 [69] S ==> policy:124662 [69]
... [output omitted] ...
```
–í–∏–¥–Ω–æ –∫–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ –≤ –Ω—É–∂–Ω–æ–π –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç–∏


## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 4: SCHED_FIFO —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

```cpp
void testFIFODiff() {
    ThreadRunner thread_runner({
        Param(SCHED_FIFO, 30, 0),
        Param(SCHED_FIFO, 90, 1),
        Param(SCHED_FIFO, 30, 2),
        Param(SCHED_FIFO, 40, 3),
        Param(SCHED_FIFO, 40, 4),
        Param(SCHED_FIFO, 30, 5),
        Param(SCHED_FIFO, 30, 6),
        Param(SCHED_FIFO, 90, 7),
        Param(SCHED_FIFO, 90, 8),
        Param(SCHED_FIFO, 30, 9),
    });
    thread_runner.run();
}
```

–û—Ç–º–µ—á—É, —á—Ç–æ –≤ –∫–æ–¥ `ThreadRunner` –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:
```cpp
static void *foo(void *param) {
        ...
        // sleep() here added for testFIFODiff (bc FIFO is cooperative policy we need sleep,
        // so that the threads can wait for each other to set priorities.)
        sleep(1);
        ...
}
```

–í–∑–≥–ª—è–Ω–µ–º –Ω–∞ *compressed_output.txt*:
```
1...1 100000
7...7 100000
8...8 100000
3...3 100000
4...4 100000
0...0 100000
2...2 100000
5...5 100000
6...6 100000
9...9 100000
```
–ö–∞–∫ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å - –ø–æ—Ç–æ–∫–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ –∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testFIFODiff/testFIFODiff.png)  


‚ÑπÔ∏è ***–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è Round Robin (RR) –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —Ç–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏. –ö–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–≤–∞–Ω—Ç) –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ CPU. –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫–≤–∞–Ω—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–µ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É –≤ –æ—á–µ—Ä–µ–¥–∏. –ö–∞–∫ –≤–∏–¥–Ω–æ –Ω–∏–∂–µ –≤ –º–æ–µ–π —Å–∏—Å—Ç–µ–º–µ –∫–≤–∞–Ω—Ç —Ä–∞–≤–µ–Ω 100 ms:*
```bash
‚ûú  ~ cat /proc/sys/kernel/sched_rr_timeslice_ms 
100
```

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 5: SCHED_RR —Å —Ä–∞–≤–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

```cpp
void testRREq() {
    ThreadRunner thread_runner({
        Param(SCHED_RR, 30, 0),
        Param(SCHED_RR, 30, 1),
        Param(SCHED_RR, 30, 2),
        Param(SCHED_RR, 30, 3),
        Param(SCHED_RR, 30, 4),
        Param(SCHED_RR, 30, 5),
        Param(SCHED_RR, 30, 6),
        Param(SCHED_RR, 30, 7),
        Param(SCHED_RR, 30, 8),
        Param(SCHED_RR, 30, 9),
    });
    thread_runner.run();
}
```

–í–∑–≥–ª—è–Ω–µ–º –Ω–∞ –ª–æ–≥ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ *testRREq.log*:
```
... [output omitted] ...
          policy-137993 [000] 112138.647335: sched_switch:         policy:137993 [69] R ==> policy:137994 [69]
          policy-137994 [000] 112138.747334: sched_switch:         policy:137994 [69] R ==> policy:137995 [69]
          policy-137995 [000] 112138.847331: sched_switch:         policy:137995 [69] R ==> policy:137996 [69]
          policy-137996 [000] 112138.947330: sched_switch:         policy:137996 [69] R ==> policy:137997 [69]
          policy-137997 [000] 112139.047327: sched_switch:         policy:137997 [69] R ==> policy:137998 [69]
          policy-137998 [000] 112139.147324: sched_switch:         policy:137998 [69] R ==> policy:137999 [69]
          policy-137999 [000] 112139.247323: sched_switch:         policy:137999 [69] R ==> policy:138000 [69]
          policy-138000 [000] 112139.347321: sched_switch:         policy:138000 [69] R ==> policy:138001 [69]
          <idle>-0     [000] 112139.498209: sched_switch:         swapper/0:0 [120] R ==> policy:137992 [69]
          policy-137992 [000] 112139.597313: sched_switch:         policy:137992 [69] R ==> policy:137993 [69]
          policy-137993 [000] 112139.697310: sched_switch:         policy:137993 [69] R ==> policy:137994 [69]
          policy-137994 [000] 112139.797308: sched_switch:         policy:137994 [69] R ==> policy:137995 [69]
          policy-137995 [000] 112139.897306: sched_switch:         policy:137995 [69] R ==> policy:137996 [69]
          policy-137996 [000] 112139.997306: sched_switch:         policy:137996 [69] R ==> policy:137997 [69]
          policy-137997 [000] 112140.097301: sched_switch:         policy:137997 [69] R ==> policy:137998 [69]
          policy-137998 [000] 112140.197299: sched_switch:         policy:137998 [69] R ==> policy:137999 [69]
          policy-137999 [000] 112140.297296: sched_switch:         policy:137999 [69] R ==> policy:138000 [69]
          policy-138000 [000] 112140.397293: sched_switch:         policy:138000 [69] R ==> policy:138001 [69]
        cinnamon-86751 [000] 112140.498162: sched_switch:         cinnamon:86751 [120] R ==> policy:138001 [69]
          policy-138001 [000] 112140.546292: sched_switch:         policy:138001 [69] R ==> policy:137992 [69]
          policy-137992 [000] 112140.646288: sched_switch:         policy:137992 [69] R ==> policy:137993 [69]
          policy-137993 [000] 112140.746290: sched_switch:         policy:137993 [69] R ==> policy:137994 [69]
          policy-137994 [000] 112140.846283: sched_switch:         policy:137994 [69] R ==> policy:137995 [69]
          policy-137995 [000] 112140.946281: sched_switch:         policy:137995 [69] R ==> policy:137996 [69]
          policy-137996 [000] 112141.046278: sched_switch:         policy:137996 [69] R ==> policy:137997 [69]
          policy-137997 [000] 112141.146275: sched_switch:         policy:137997 [69] R ==> policy:137998 [69]
          policy-137998 [000] 112141.246273: sched_switch:         policy:137998 [69] R ==> policy:137999 [69]
          policy-137999 [000] 112141.346270: sched_switch:         policy:137999 [69] R ==> policy:138000 [69]
          policy-138000 [000] 112141.446267: sched_switch:         policy:138000 [69] R ==> policy:138001 [69]
... [output omitted] ...
```
–í–∏–¥–Ω–æ –∫–∞–∫ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏.

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testRREq/testRREq.png)  
–ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç "–ª–µ—Å–µ–Ω–∫–∏" –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ CPU –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏, —á—Ç–æ, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º –æ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ Round Robin (RR).

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 6: SCHED_RR —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

```cpp
void testRRDiff() {
    ThreadRunner thread_runner({
        Param(SCHED_RR, 30, 0),
        Param(SCHED_RR, 90, 1),
        Param(SCHED_RR, 30, 2),
        Param(SCHED_RR, 40, 3),
        Param(SCHED_RR, 40, 4),
        Param(SCHED_RR, 30, 5),
        Param(SCHED_RR, 30, 6),
        Param(SCHED_RR, 90, 7),
        Param(SCHED_RR, 90, 8),
        Param(SCHED_RR, 30, 9),
    });
    thread_runner.run();
}
```

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testRRDiff/testRRDiff.png)  
–í–∏–¥–Ω–æ, —á—Ç–æ –∑–∞–¥–∞—á–∏ –∑–∞–Ω–∏–º–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã–π —Ä–µ—Å—É—Ä—Å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å–≤–æ–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º. –í–Ω—É—Ç—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∑–∞–¥–∞—á —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Å–≤–æ—è "–ª–µ—Å–µ–Ω–∫–∞"

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 7: `sched_yield()`

`sched_yield` ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ—Ç–æ–∫—É –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä, –ø–µ—Ä–µ–¥–∞–≤–∞—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–∞–º —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º.

–î–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ä—É—Ç–∏–Ω—É –¥–ª—è RR –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
```cpp
// routine for SCHED_RR policy

for (int i=0; i<2; ++i) {
    time_t start = time(NULL);
    while (time(NULL) - start < 2) {
        ...
        // for experiment 7
        // set iterations count to low value!!!
        sched_yield();
    }
}
```

–ó–∞–ø—É—Å—Ç–∏–º testRREq()

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testRREqYield/testRREqYield.png)  
–¢–µ–ø–µ—Ä—å —ç—Ñ—Ñ–µ–∫—Ç "–ª–µ—Å–µ–Ω–∫–∏" –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø–æ—Å–∫–æ–ª—å–∫—É –∫–≤–∞–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –∏ –∑–∞–¥–∞—á–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã CPU –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –∏ —É–ª—É—á—à–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 8: —Å–º–µ—à–∞–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏

```cpp
void testMixed() {
    ThreadRunner thread_runner({
        Param(SCHED_OTHER, 0, 0),
        Param(SCHED_RR, 30, 1),
        Param(SCHED_OTHER, 0, 2),
        Param(SCHED_OTHER, 0, 3),
        Param(SCHED_RR, 30, 4),
        Param(SCHED_RR, 30, 5),
        Param(SCHED_RR, 30, 6),
        Param(SCHED_OTHER, 0, 7),
        Param(SCHED_RR, 30, 8),
        Param(SCHED_RR, 30, 9),
    });
    thread_runner.run();
}
```

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:  
![Image alt](./testMixed/testMixed.png)  
–í–∏–¥–Ω–æ, —á—Ç–æ –≤ Linux –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ FIFO –∏–º–µ–µ—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å CFS.

# –í—ã–≤–æ–¥—ã

- **`SCHED_OTHER` (CFS):**  
  - –ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç CPU –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ —á–µ—Ä–µ–∑ **nice-–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** (`-20` ‚Äî –≤—ã—Å—à–∏–π, `19` ‚Äî –Ω–∏–∑—à–∏–π).  
  - –î–ª—è –∑–∞–¥–∞—á –±–µ–∑ –∂–µ—Å—Ç–∫–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.  
  - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: `SCHED_OTHER` < `SCHED_RR`/`SCHED_FIFO`.

- **`SCHED_FIFO`:**  
  - **Real-Time** (RT) –±–µ–∑ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è.  
  - –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∏–ª–∏ –Ω–µ —É—Å—Ç—É–ø–∏—Ç CPU.  
  - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: `1` (–Ω–∏–∑–∫–∏–π) ‚Äì `99` (–≤—ã—Å–æ–∫–∏–π).  
  - –†–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞.

- **`SCHED_RR`:**  
  - RT —Å –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ–º (—Ä–æ—Ç–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞).  
  - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–≤–∞–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è).  
  - –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º—è–≥–∫–æ–≥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

- **–°–º–µ—à–∞–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏:**  
  - RT-–ø–æ—Ç–æ–∫–∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ `SCHED_OTHER`.  
  - –†–∏—Å–∫ –≥–æ–ª–æ–¥–∞–Ω–∏—è CFS-–∑–∞–¥–∞—á –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö RT-–ø–æ—Ç–æ–∫–∞—Ö.